<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Word to PDF Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: none; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card p-4">
            <h1>Convert Word to PDF</h1>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" name="file" class="form-control mb-3" accept=".docx" required>
                <button type="submit" class="btn btn-primary">Upload & Convert</button>
            </form>
            <div id="result"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const resultDiv = document.getElementById('result');
            
            try {
                // Show loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                resultDiv.innerHTML = '<div class="alert alert-info">Processing your file, please wait...</div>';

                const response = await fetch('/upload', { 
                    method: 'POST', 
                    body: new FormData(form) 
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error processing your file');
                }

                // Always show the payment form if payment is required
                if (data.page_count > 50) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <h5>Payment Required</h5>
                            <p>Your document has ${data.page_count} pages. Please complete the payment to download.</p>
                            <form id="payForm" class="mt-3">
                                <input type="hidden" name="conversion_uuid" value="${data.conversion_uuid}">
                                <div class="mb-3">
                                    <label class="form-label">Payment Method</label>
                                    <select name="method" class="form-select mb-3" required>
                                        <option value="">Select payment method</option>
                                        <option value="usdt">USDT</option>
                                        <option value="credit_card">Credit Card</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="txHashField" style="display: none;">
                                    <label class="form-label">Transaction Hash (USDT)</label>
                                    <input type="text" name="tx_hash" class="form-control" placeholder="Enter your USDT transaction hash">
                                </div>
                                <button type="submit" class="btn btn-success">Pay & Download</button>
                            </form>
                        </div>
                    `;

                    // Show/hide TX hash field based on payment method
                    document.querySelector('select[name="method"]').addEventListener('change', (e) => {
                        document.getElementById('txHashField').style.display = 
                            e.target.value === 'usdt' ? 'block' : 'none';
                    });

                    // Handle payment form submission
                    document.getElementById('payForm').addEventListener('submit', handlePayment);
                } else {
                    // For free files, show download button that uses the conversion UUID
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5>Conversion Complete!</h5>
                            <p>Your file has been converted successfully (${data.page_count} pages).</p>
                            <button onclick="downloadFile('${data.conversion_uuid}')" class="btn btn-primary">Download PDF</button>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Error</h5>
                        <p>${error.message || 'An error occurred while processing your file.'}</p>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload & Convert';
                form.reset();
            }
        });

        async function downloadFile(conversionUuid, pageCount = null) {
            const resultDiv = document.getElementById('result');
            try {
                // If we know the page count is over 50, don't even try to download directly
                if (pageCount && pageCount > 50) {
                    showPaymentForm(conversionUuid, pageCount);
                    return;
                }
                
                const response = await fetch(`/download/${conversionUuid}`);
                
                if (response.status === 402) {
                    // Handle payment required
                    const errorData = await response.json();
                    showPaymentForm(conversionUuid, errorData.page_count);
                    return;
                }
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Download failed');
                }
                
                // Trigger file download
                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                const filenameMatch = contentDisposition && contentDisposition.match(/filename="?(.+)"?/);
                const filename = filenameMatch ? filenameMatch[1] : 'converted.pdf';
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5>Download Complete!</h5>
                        <p>Your PDF has been downloaded.</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Download Error</h5>
                        <p>${error.message || 'An error occurred while downloading your file.'}</p>
                    </div>
                `;
            }
        }

        function showPaymentForm(conversionUuid, pageCount) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h5>Payment Required</h5>
                    <p>Your document has ${pageCount} pages. Documents over 50 pages require payment to download.</p>
                    <form id="payForm" class="mt-3">
                        <input type="hidden" name="conversion_uuid" value="${conversionUuid}">
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <select name="method" class="form-select mb-3" required>
                                <option value="">Select payment method</option>
                                <option value="usdt">USDT</option>
                                <option value="credit_card">Credit Card</option>
                            </select>
                        </div>
                        <div class="mb-3" id="txHashField" style="display: none;">
                            <label class="form-label">Transaction Hash (USDT)</label>
                            <input type="text" name="tx_hash" class="form-control" placeholder="Enter your USDT transaction hash">
                        </div>
                        <button type="submit" class="btn btn-success">Pay & Download</button>
                    </form>
                </div>
            `;
            
            document.querySelector('select[name="method"]').addEventListener('change', (e) => {
                document.getElementById('txHashField').style.display = 
                    e.target.value === 'usdt' ? 'block' : 'none';
            });
            
            document.getElementById('payForm').addEventListener('submit', handlePayment);
        }
        
        async function handlePayment(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const resultDiv = document.getElementById('result');
            const conversionUuid = form.querySelector('input[name="conversion_uuid"]').value;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing Payment...';
                
                const formData = new FormData(form);
                const response = await fetch('/pay', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Payment processing failed');
                }
                
                // If payment is successful, trigger the download
                await downloadFile(conversionUuid, null);
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Payment Error</h5>
                        <p>${error.message || 'An error occurred while processing your payment.'}</p>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Pay & Download';
            }
        }
    </script>
</body>
</html>